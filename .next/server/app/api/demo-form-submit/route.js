"use strict";(()=>{var e={};e.id=623,e.ids=[623],e.modules={517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9961:(e,o,t)=>{t.r(o),t.d(o,{headerHooks:()=>b,originalPathname:()=>P,patchFetch:()=>S,requestAsyncStorage:()=>h,routeModule:()=>g,serverHooks:()=>D,staticGenerationAsyncStorage:()=>f,staticGenerationBailout:()=>y});var s={};t.r(s),t.d(s,{POST:()=>m,dynamic:()=>c,maxDuration:()=>d,runtime:()=>p});var r=t(884),i=t(6132),a=t(1040),n=t(5798);async function l(e,o){console.log(`Uploading ${e.length} photos for patient ${o}`);let t={};return e.forEach((e,s)=>{let r=`photo-${s}`;t[r]={success:!0,url:`https://storage.googleapis.com/placeholder-bucket/patient-${o}-photo-${s}.jpg`}}),t}async function u(e){return console.log(`Ensuring bucket ${e} exists`),!0}let c="force-dynamic",d=60,p="nodejs";async function m(e){let o=Date.now();try{console.log("\uD83D\uDE80 Demo form submission started at",new Date().toISOString()),console.log("\uD83C\uDF0D Environment:","production"),console.log("\uD83C\uDF0D Vercel region:",process.env.VERCEL_REGION),console.log("\uD83C\uDF0D Function timeout:",process.env.VERCEL_FUNCTION_TIMEOUT),console.log("\uD83D\uDCF1 User-Agent:",e.headers.get("user-agent")),console.log("\uD83D\uDCF1 Content-Type:",e.headers.get("content-type")),console.log("\uD83D\uDCF1 Content-Length:",e.headers.get("content-length"));let t=await e.formData();console.log("\uD83D\uDCDD Form data received"),console.log("\uD83D\uDCDD Form data entries:",Array.from(t.entries()).map(([e,o])=>[e,o instanceof File?`File: ${o.name} (${o.size} bytes)`:o]));let s=t.get("firstName"),r=t.get("lastName"),i=t.get("email"),a=t.get("phone"),c=t.get("dateOfBirth"),d=[],p=[];try{let e=t.get("previousProcedures");e&&(d=JSON.parse(e))}catch(e){console.warn("Failed to parse previousProcedures:",e)}try{let e=t.get("goals");e&&(p=JSON.parse(e))}catch(e){console.warn("Failed to parse goals:",e)}try{let e=t.get("regions");e&&JSON.parse(e)}catch(e){console.warn("Failed to parse regions:",e)}let m=t.get("frontPhoto"),g=t.get("leftSidePhoto"),h=t.get("rightSidePhoto"),f=t.get("expressions"),D=(e,o)=>{e?console.log(`ðŸ“ ${o}:`,{name:e.name,size:e.size,type:e.type,lastModified:e.lastModified,sizeMB:(e.size/1048576).toFixed(2)+" MB"}):console.log(`ðŸ“ ${o}: null`)};D(m,"Front Photo"),D(g,"Left Side Photo"),D(h,"Right Side Photo"),D(f,"Expressions File"),console.log("\uD83D\uDCCA Form data extracted:",{firstName:s,lastName:r,email:i,phone:a,dateOfBirth:c,hasFrontPhoto:!!m,hasLeftPhoto:!!g,hasRightPhoto:!!h,hasExpressions:!!f}),console.log("\uD83D\uDD27 Environment check:",{hasProjectId:!!process.env.GOOGLE_CLOUD_PROJECT_ID,hasClientEmail:!!process.env.GOOGLE_CLOUD_CLIENT_EMAIL,hasPrivateKey:!!process.env.GOOGLE_CLOUD_PRIVATE_KEY,hasAirtableBaseId:!!process.env.AIRTABLE_BASE_ID,hasAirtableApiKey:!!process.env.AIRTABLE_API_KEY});let b=process.memoryUsage();console.log("\uD83E\uDDE0 Memory usage:",{rss:Math.round(b.rss/1024/1024)+" MB",heapTotal:Math.round(b.heapTotal/1024/1024)+" MB",heapUsed:Math.round(b.heapUsed/1024/1024)+" MB",external:Math.round(b.external/1024/1024)+" MB"}),console.log("\uD83E\uDEA3 Checking Google Cloud Storage bucket...");let y=await u("aesthetics-ai-photos");y?console.log("âœ… Google Cloud Storage bucket ready"):console.warn("âš ï¸ Google Cloud Storage not available, continuing without photo uploads");let P=["image/jpeg","image/jpg","image/png","image/webp"],S=["video/mp4","video/quicktime","video/x-msvideo","video/webm"],E=(e,o)=>{let t=[];return(e.size>("expressions"===o?52428800:26214400)&&t.push(`File too large: ${(e.size/1048576).toFixed(2)}MB (max ${"expressions"===o?"25MB":"10MB"})`),"expressions"===o?P.includes(e.type)||S.includes(e.type)||t.push(`Invalid file type: ${e.type}. Allowed: images (${P.join(", ")}) or videos (${S.join(", ")})`):P.includes(e.type)||t.push(`Invalid file type: ${e.type}. Allowed: ${P.join(", ")}`),t.length>0)?(console.error(`âŒ File validation failed for ${o}:`,t),{valid:!1,errors:t}):{valid:!0,errors:[]}},v=[],w=[];if(m){let e=E(m,"frontPhoto");e.valid?v.push({file:m,name:`front-${Date.now()}.${m.name.split(".").pop()}`,type:"frontPhoto"}):w.push(...e.errors)}if(g){let e=E(g,"leftSidePhoto");e.valid?v.push({file:g,name:`left-${Date.now()}.${g.name.split(".").pop()}`,type:"leftSidePhoto"}):w.push(...e.errors)}if(h){let e=E(h,"rightSidePhoto");e.valid?v.push({file:h,name:`right-${Date.now()}.${h.name.split(".").pop()}`,type:"rightSidePhoto"}):w.push(...e.errors)}if(f){let e=E(f,"expressions");e.valid?v.push({file:f,name:`expressions-${Date.now()}.${f.name.split(".").pop()}`,type:"expressions"}):w.push(...e.errors)}if(w.length>0)return console.error("âŒ File validation errors:",w),n.Z.json({success:!1,error:"File validation failed",details:w},{status:400});let A={};if(v.length>0&&y){console.log(`ðŸ“¸ Uploading ${v.length} files to Google Cloud Storage...`),console.log("\uD83D\uDCF8 Files to upload:",v.map(e=>({type:e.type,name:e.name,size:e.file.size,sizeMB:(e.file.size/1048576).toFixed(2)+" MB"})));let e=Date.now();try{A=await l(v.map(e=>e.file),"demo-form");let o=Date.now()-e;console.log(`ðŸ“¸ Upload completed in ${o}ms`),console.log("\uD83D\uDCF8 Photo upload results:",A)}catch(e){console.error("âŒ Upload error:",e),v.forEach(o=>{A[o.type]={success:!1,error:e instanceof Error?e.message:"Upload failed"}})}}else v.length>0&&(console.log("\uD83D\uDCF8 Skipping photo uploads - Google Cloud Storage not available"),v.forEach(e=>{A[e.type]={success:!1,error:"Google Cloud Storage not available"}}));let F=`DEMO-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,$={frontPhoto:A.frontPhoto?.success?A.frontPhoto.url:null,leftSidePhoto:A.leftSidePhoto?.success?A.leftSidePhoto.url:null,rightSidePhoto:A.rightSidePhoto?.success?A.rightSidePhoto.url:null,expressions:A.expressions?.success?A.expressions.url:null},C={Name:`${s} ${r}`,Email:i,"Phone Number":a,Birthday:c?new Date(c).toISOString():null,"Submission Date":new Date().toISOString(),"Form Name":"V3 Demo Facial Analysis Intake","Submission ID":F,"Approval Status":"Waiting for Analysis","Source (from Jotform)":"LeadValue"};d&&d.length>0&&(C["Have you had any aesthetic procedures?"]=d),p&&p.length>0&&(C["What would you like to improve?"]=p),$.frontPhoto&&(C["Front Photo"]=[{url:$.frontPhoto,filename:`front-${Date.now()}.jpg`}]),$.rightSidePhoto&&(C["Side Photo"]=[{url:$.rightSidePhoto,filename:`side-${Date.now()}.jpg`}]),$.leftSidePhoto&&(C["Left Side Photo"]=[{url:$.leftSidePhoto,filename:`left-${Date.now()}.jpg`}]),$.expressions&&(C.Animation=[{url:$.expressions,filename:`expressions-${Date.now()}.mp4`}]);let x={fields:C};console.log("\uD83D\uDCCB Submitting to Airtable..."),console.log("\uD83D\uDCCB Airtable data:",JSON.stringify(x,null,2));let O=process.env.AIRTABLE_API_KEY,I=process.env.AIRTABLE_BASE_ID||"appXblSpAMBQskgzB";if(!I||!O)return console.warn("âš ï¸ Airtable credentials not available, skipping Airtable submission"),n.Z.json({success:!0,message:"Form submitted successfully (without Airtable)",warning:"Airtable submission skipped - credentials not available"});let M=await fetch(`https://api.airtable.com/v0/${I}/Form%20Submissions?typecast=true`,{method:"POST",headers:{Authorization:`Bearer ${O}`,"Content-Type":"application/json"},body:JSON.stringify(x)});if(console.log("\uD83D\uDCCB Airtable response status:",M.status),!M.ok){let e=await M.text();return console.error("âŒ Airtable API error:",e),console.error("âŒ Airtable response status:",M.status),console.error("âŒ Airtable response headers:",Object.fromEntries(M.headers.entries())),console.warn("âš ï¸ Airtable submission failed, but continuing with success response"),n.Z.json({success:!0,message:"Form submitted successfully (Airtable submission failed)",warning:`Airtable error: ${M.status} - ${e}`})}let B=await M.json();console.log("Successfully submitted to Airtable:",B);let k=Date.now()-o;return console.log(`âœ… Form submission completed successfully in ${k}ms`),n.Z.json({success:!0,message:"Form submitted successfully",airtableId:B.id,duration:k})}catch(r){let e=Date.now()-o;console.error(`âŒ Form submission error after ${e}ms:`,r),console.error("âŒ Error details:",{message:r instanceof Error?r.message:"Unknown error",stack:r instanceof Error?r.stack:void 0,name:r?.name,code:r?.code,status:r?.status});let t="Failed to submit form",s=500;return r instanceof Error&&(r.message.includes("timeout")||r.message.includes("TIMEOUT")?(t="Request timed out. Please try with a smaller file.",s=408):r.message.includes("memory")||r.message.includes("MEMORY")?(t="File too large. Please try with a smaller file.",s=413):r.message.includes("permission")||r.message.includes("PERMISSION")?(t="Permission denied. Please check your Google Cloud Storage configuration.",s=403):(r.message.includes("network")||r.message.includes("NETWORK"))&&(t="Network error. Please check your internet connection and try again.",s=503)),n.Z.json({success:!1,error:t,details:r instanceof Error?r.message:"Unknown error",duration:e},{status:s})}}let g=new r.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/demo-form-submit/route",pathname:"/api/demo-form-submit",filename:"route",bundlePath:"app/api/demo-form-submit/route"},resolvedPagePath:"/Users/sambrause/Downloads/aesthetics-ai-demo REVERTED/src/app/api/demo-form-submit/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:h,staticGenerationAsyncStorage:f,serverHooks:D,headerHooks:b,staticGenerationBailout:y}=g,P="/api/demo-form-submit/route";function S(){return(0,a.patchFetch)({serverHooks:D,staticGenerationAsyncStorage:f})}}};var o=require("../../../webpack-runtime.js");o.C(e);var t=e=>o(o.s=e),s=o.X(0,[271,107],()=>t(9961));module.exports=s})();